<div class="p-d-flex p-jc-between p-ai-center p-mb-3 p-px-2">
  <div class="p-input-icon-left">
    <i class="pi pi-search"></i>
    <input pInputText type="text" (input)="dt.filterGlobal(($any($event.target)).value, 'contains')" placeholder="Search..." class="global-search" />
  </div>
</div>

<p-table #dt [value]="tasks"
         responsiveLayout="scroll"
         [paginator]="true"
         [rows]="25"
         [globalFilterFields]="['name', 'rewards', 'assigneeName', 'description', 'skills']"
         sortMode="multiple"
         styleClass="p-datatable-sm compact-table">

  <ng-template pTemplate="header">
    <tr>
      <th pSortableColumn="name"><i class="pi pi-tag" pTooltip="Name"></i> <p-sortIcon field="name"></p-sortIcon></th>
      <th pSortableColumn="skills"><i class="pi pi-users" pTooltip="Skills"></i> <p-sortIcon field="skills"></p-sortIcon></th>
      <th pSortableColumn="effortMin"><i class="pi pi-clock" pTooltip="Min. Aufwand"></i> <p-sortIcon field="effortMin"></p-sortIcon></th>
      <th pSortableColumn="effortMax"><i class="pi pi-angle-double-right" pTooltip="Max"></i> <p-sortIcon field="effortMax"></p-sortIcon></th>
      <th pSortableColumn="rewards"><i class="pi pi-star" pTooltip="Reward"></i> <p-sortIcon field="rewards"></p-sortIcon></th>
      <th pSortableColumn="startDate"><i class="pi pi-calendar-plus" pTooltip="Start Date"></i> <p-sortIcon field="startDate"></p-sortIcon></th>
      <th pSortableColumn="dueDate"><i class="pi pi-calendar-times" pTooltip="Deadline"></i> <p-sortIcon field="dueDate"></p-sortIcon></th>
      <th pSortableColumn="isCompleted"><i class="pi pi-check-square" pTooltip="Completed"></i> <p-sortIcon field="isCompleted"></p-sortIcon></th>
      <th pSortableColumn="status"><i class="pi pi-info-circle" pTooltip="Status"></i> <p-sortIcon field="status"></p-sortIcon></th>
      <th pSortableColumn="assigneeName"><i class="pi pi-user" pTooltip="Assignee"></i> <p-sortIcon field="assigneeName"></p-sortIcon></th>
      <th><i class="pi pi-cog"></i></th>
    </tr>
    <tr>
      <th><p-columnFilter type="text" field="name"></p-columnFilter></th>
      <th><p-columnFilter type="text" field="skills"></p-columnFilter></th>
      <th><p-columnFilter type="numeric" field="effortMin"></p-columnFilter></th>
      <th><p-columnFilter type="numeric" field="effortMax"></p-columnFilter></th>
      <th><p-columnFilter type="numeric" field="rewards"></p-columnFilter></th>
      <th><p-columnFilter type="date" field="startDate"></p-columnFilter></th>
      <th><p-columnFilter type="date" field="dueDate"></p-columnFilter></th>
      <th><p-columnFilter type="boolean" field="isCompleted"></p-columnFilter></th>
      <th>
        <p-columnFilter field="status" matchMode="equals" [showMenu]="false">
          <ng-template pTemplate="filter" let-value let-filter="filterCallback">
            <p-dropdown [options]="statusOptions" (onChange)="filter($event.value)" placeholder="Status"></p-dropdown>
          </ng-template>
        </p-columnFilter>
      </th>
      <th><p-columnFilter type="text" field="assigneeName"></p-columnFilter></th>
      <th></th>
    </tr>
  </ng-template>

  <ng-template pTemplate="body" let-task>
    <tr>
      <td><a [routerLink]="['/task', task.id]" class="task-link">{{ task.name }}</a></td>
      <td>
        <ng-container *ngIf="task.skills?.length">
          <span *ngFor="let skill of task.skills" class="chip">{{ skill }}</span>
        </ng-container>
      </td>
      <td>{{ task.effortMin }}</td>
      <td>{{ task.effortMax }}</td>
      <td>{{ task.rewards }}</td>
      <td>{{ task.startDate | date:'yyyy-MM-dd' }}</td>
      <td>{{ task.dueDate | date:'yyyy-MM-dd' }}</td>
      <td>
        <p-tag [value]="task.isCompleted ? 'Yes' : 'No'" [severity]="task.isCompleted ? 'success' : 'warning'"></p-tag>
      </td>
      <td>
        <ng-container [ngSwitch]="getStatusLabel(task.status)">
          <p-tag *ngSwitchCase="'Done'" severity="success" [value]="getStatusLabel(task.status)"></p-tag>
          <p-tag *ngSwitchCase="'InProgress'" severity="info" [value]="getStatusLabel(task.status)"></p-tag>
          <p-tag *ngSwitchCase="'Blocked'" severity="danger" [value]="getStatusLabel(task.status)"></p-tag>
          <p-tag *ngSwitchCase="'Waiting'" severity="warning" [value]="getStatusLabel(task.status)"></p-tag>
          <p-tag *ngSwitchDefault severity="info" [value]="getStatusLabel(task.status)"></p-tag>
        </ng-container>
      </td>
      <td>{{ task.assigneeName || 'Unassigned' }}</td>
      <td>
        <button *ngIf="!task.isCompleted && permissionService.canDeleteTasks()"
                pButton icon="pi pi-trash"
                class="p-button-rounded p-button-danger p-button-text"
                (click)="deleteTask(task.id)"
                pTooltip="Delete task"
                aria-label="Delete task"></button>
      </td>
    </tr>
  </ng-template>
</p-table>

<div class="new-task-container p-mt-3" *ngIf="permissionService.canCreateTasks()">
  <p-button label="Neues Task" icon="pi pi-plus" severity="success" [routerLink]="['/task/new']"></p-button>
  <p-button label="Schnelleingabe" icon="pi pi-bolt" severity="info" [routerLink]="['/task/quick-add']" class="p-ml-2"></p-button>
</div>

<p-toast></p-toast>
<p-confirmDialog header="Confirmation" icon="pi pi-exclamation-triangle"></p-confirmDialog>
